<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Command Sequence Verifier</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; background-color: #2c2c2c; color: #f0f0f0; padding: 20px; font-size: 14px; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; }
        h1, h2 { color: #4a90e2; border-bottom: 1px solid #555; padding-bottom: 10px; }
        button { padding: 10px 15px; font-size: 16px; margin: 10px 0; border-radius: 5px; border: 1px solid #666; background-color: #444; color: white; cursor: pointer; width: 100%; transition: background-color 0.2s; }
        button:disabled { background-color: #333; opacity: 0.5; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #555; }
        #startBtn { background-color: #27ae60; }
        #startBtn:hover:not(:disabled) { background-color: #2ecc71; }
        #stopBtn { background-color: #c0392b; }
        #stopBtn:hover:not(:disabled) { background-color: #e74c3c; }
        .panel { background-color: #1e1e1e; border: 1px solid #555; border-radius: 5px; padding: 15px; margin-top: 20px; }
        textarea { width: 100%; height: 250px; background-color: #222; border: 1px solid #555; color: white; padding: 10px; border-radius: 3px; resize: vertical; font-family: 'SF Mono', 'Consolas', 'Menlo', monospace; }
        #log { width: 100%; height: 300px; overflow-y: scroll; font-family: 'SF Mono', 'Consolas', 'Menlo', monospace; font-size: 12px; white-space: pre; word-break: break-all; }
        .log-sent { color: #87cefa; }
        .log-received { color: #98fb98; }
        .log-error { color: #ff6b6b; }
        .log-info { color: #f0e68c; }
        .log-success { color: #32cd32; font-weight: bold; }
        .status-bar { display: flex; align-items: center; gap: 10px; background-color: #3a3a3a; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        #status-dot { width: 12px; height: 12px; border-radius: 50%; background-color: #ff6b6b; transition: background-color 0.3s; }
        #status-dot.connected { background-color: #32cd32; }
        #status-text { font-weight: bold; }
        #progress-bar-container { width: 100%; background-color: #444; border-radius: 5px; overflow: hidden; height: 20px; margin-top: 10px; }
        #progress-bar { width: 0%; height: 100%; background-color: #4a90e2; transition: width 0.1s linear; }
        .controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .controls label { font-weight: bold; }
        .controls input[type="number"] { background-color: #222; border: 1px solid #555; color: white; padding: 8px; border-radius: 3px; font-size: 14px; width: 80px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Command Sequence Verifier</h1>
        <p>Paste the commands generated by the cracking tool, connect to the pedal, and run the sequence to verify each command works and is in the correct order.</p>

        <div class="status-bar">
            <div id="status-dot"></div>
            <span id="status-text">Disconnected</span>
        </div>

        <button id="connectBtn">1. Connect to Pedal</button>

        <div class="panel">
            <h2>Commands to Verify</h2>
            <textarea id="commandsInput" placeholder="Paste your raw command strings here, separated by lines or spaces.

Example:
8080f0...f7
8080f0...f7
8080f0...f7"></textarea>
        </div>

        <div class="panel">
            <h2>Verification Controls</h2>
            <div class="controls">
                <label for="delayInput">Delay (ms):</label>
                <input type="number" id="delayInput" value="500" min="100">
            </div>
            <button id="startBtn" disabled>2. Start Verification</button>
            <button id="stopBtn" style="display: none;">Stop Verification</button>
        </div>

        <div class="panel">
            <h2>Verification Log</h2>
            <div id="progress-bar-container"><div id="progress-bar"></div></div>
            <div id="log"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SERVICE_UUID = '03b80e5a-ede8-4b33-a751-6ce34ec4c700';
        const CHARACTERISTIC_UUID = '7772e5db-3868-4112-a1a9-f2669d106bf3';
        const SUCCESS_ACK_CODE = "8080f00b02000100000003010400080000f7";
        const ACK_TIMEOUT = 400; // Slightly longer timeout for verification

        // --- DEVICE STATE ---
        let device = null;
        let characteristic = null;
        let currentAckResolver = null;
        let isVerifying = false;

        // --- UI ELEMENTS ---
        const connectBtn = document.getElementById('connectBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const commandsInput = document.getElementById('commandsInput');
        const delayInput = document.getElementById('delayInput');
        const logElement = document.getElementById('log');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const progressBar = document.getElementById('progress-bar');

        // --- LOGIC ---
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = `log-${type}`;
            const newEntry = document.createElement('div');
            newEntry.className = typeClass;
            newEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(newEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function setControlsDisabled(disabled) {
            isVerifying = disabled;
            startBtn.disabled = disabled;
            commandsInput.disabled = disabled;
            delayInput.disabled = disabled;
            stopBtn.style.display = disabled ? 'block' : 'none';
            if (device) { // Re-enable start button if connected but not verifying
                 startBtn.disabled = disabled || !device;
            }
        }
        
        connectBtn.addEventListener('click', async () => {
            if (!navigator.bluetooth) {
                log('Web Bluetooth is not supported in this browser.', 'error');
                return;
            }
            try {
                log('Requesting Bluetooth device...', 'info');
                device = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
                log(`Connecting to ${device.name || 'Unknown Device'}...`, 'info');
                device.addEventListener('gattserverdisconnected', onDisconnected);
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleNotification);
                
                statusDot.classList.add('connected');
                statusText.textContent = `Connected to ${device.name}`;
                log('Device connected successfully!', 'success');
                connectBtn.disabled = true;
                startBtn.disabled = false;
            } catch (error) {
                log(`Connection failed: ${error.message}`, 'error');
            }
        });

        function onDisconnected() {
            log('Device disconnected.', 'error');
            statusDot.classList.remove('connected');
            statusText.textContent = 'Disconnected';
            connectBtn.disabled = false;
            setControlsDisabled(true); // Disable controls on disconnect
            startBtn.disabled = true;
            device = null;
            characteristic = null;
        }

        async function writeCommand(commandString) {
            if (!characteristic) return;
            try {
                const hexBytes = commandString.match(/.{1,2}/g).map(byte => parseInt(byte, 16));
                const command = new Uint8Array(hexBytes);
                await characteristic.writeValueWithoutResponse(command);
                log(`SENT: ${commandString}`, 'sent');
            } catch (error) {
                log(`Error sending command: ${error.message}`, 'error');
            }
        }

        function handleNotification(event) {
            const data = new Uint8Array(event.target.value.buffer);
            const hexString = Array.from(data).map(b => b.toString(16).padStart(2, '0')).join('');
             log(`RECV: ${hexString}`, 'received');
            if (currentAckResolver && hexString.toLowerCase() === SUCCESS_ACK_CODE) {
                currentAckResolver(true);
            }
        }
        
        function waitForAck() {
            return new Promise((resolve) => {
                let resolved = false;
                const resolver = (success) => {
                    if (!resolved) {
                        resolved = true;
                        currentAckResolver = null;
                        clearTimeout(timeout);
                        resolve(success);
                    }
                };
                currentAckResolver = resolver;
                const timeout = setTimeout(() => resolver(false), ACK_TIMEOUT);
            });
        }

        /**
         * MODIFIED FUNCTION
         * Parses the input text to find all raw command strings.
         * A command is defined as a hex string starting with '8080f0' and ending with 'f7'.
         */
        function parseCommands() {
            const text = commandsInput.value;
            // Regex to find all hex strings that start with 8080f0 and end with f7.
            // 'g' flag finds all matches, 'i' flag makes it case-insensitive.
            const regex = /(8080f0[a-fA-F0-9]+?f7)/gi;
            const matches = text.match(regex);

            if (!matches) {
                return []; // Return an empty array if no valid commands are found
            }

            // Map the found string matches to the object format the verifier expects.
            return matches.map((command, index) => ({
                name: `Command ${index + 1}`, // Generate a generic name for logging
                command: command.toLowerCase() // Ensure consistency
            }));
        }

        startBtn.addEventListener('click', async () => {
            const commandsToVerify = parseCommands();
            if (commandsToVerify.length === 0) {
                log('No valid commands found in the text field. Ensure they start with 8080f0 and end with f7.', 'error');
                return;
            }

            setControlsDisabled(true);
            log(`--- Starting Verification: ${commandsToVerify.length} commands ---`, 'info');
            progressBar.style.width = '0%';

            const delay = parseInt(delayInput.value) || 500;

            for (let i = 0; i < commandsToVerify.length; i++) {
                if (!isVerifying) {
                    log('Verification stopped by user.', 'error');
                    break;
                }

                const item = commandsToVerify[i];
                log(`Testing (${i + 1}/${commandsToVerify.length}): ${item.name}`, 'info');

                await writeCommand(item.command);
                const ackReceived = await waitForAck();

                if (ackReceived) {
                    log(`--> SUCCESS: ACK received for ${item.name}`, 'success');
                } else {
                    log(`--> FAILED: No ACK received for ${item.name}`, 'error');
                }

                progressBar.style.width = `${((i + 1) / commandsToVerify.length) * 100}%`;

                // Wait for the specified delay before the next command
                if (i < commandsToVerify.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            log('--- Verification Complete ---', 'success');
            setControlsDisabled(false);
        });

        stopBtn.addEventListener('click', () => {
            isVerifying = false;
        });

    </script>
</body>
</html>
```

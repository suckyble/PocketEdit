<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parameter Command Analyzer Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; background-color: #2c2c2c; color: #f0f0f0; padding: 20px; font-size: 14px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1, h2 { color: #3498db; border-bottom: 1px solid #555; padding-bottom: 10px; }
        button { padding: 10px 15px; font-size: 16px; margin: 10px 0; border-radius: 5px; border: 1px solid #666; background-color: #444; color: white; cursor: pointer; width: 100%; transition: background-color 0.2s; }
        button:hover:not(:disabled) { background-color: #555; }
        .panel { background-color: #1e1e1e; border: 1px solid #555; border-radius: 5px; padding: 15px; margin-top: 20px; }
        textarea { width: 100%; background-color: #222; border: 1px solid #555; color: white; padding: 10px; border-radius: 3px; resize: vertical; font-family: 'SF Mono', 'Consolas', 'Menlo', monospace; }
        #snoopedDataInput { height: 200px; }
        #resultsOutput { height: 400px; white-space: pre; }
        .controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; padding: 10px; background-color: #3a3a3a; border-radius: 5px; }
        .controls label { font-weight: bold; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Parameter Command Analyzer Tool</h1>
        <p>Paste snooped command data below. The tool will find commands, identify them by Module/Algorithm ID, sort them, and report any missing values, with special handling for Delay Time (Alg 1, Mod 7).</p>

        <div class="grid">
            <div class="panel">
                <h2>1. Snooped Data Input</h2>
                <textarea id="snoopedDataInput" placeholder="Paste your raw snooped data here. The tool will find all 8080...f7 commands."></textarea>
            </div>

            <div class="panel">
                <h2>2. Analysis Controls</h2>
                <p>The tool automatically detects values for common parameters and the special Delay Time parameter.</p>
                <button id="analyzeBtn">Analyze Commands</button>
            </div>
        </div>

        <div class="panel">
            <h2>3. Analysis Results</h2>
            <button id="generatePayloadBtn" disabled style="background-color: #16a085;">Generate & Download Missing Payloads</button>
            <textarea id="resultsOutput" readonly></textarea>
        </div>
    </div>

    <script>
        // --- UI ELEMENTS ---
        const analyzeBtn = document.getElementById('analyzeBtn');
        const snoopedDataInput = document.getElementById('snoopedDataInput');
        const resultsOutput = document.getElementById('resultsOutput');
        let lastMissingCommands = {};

        // --- DATA MAPPING ---
        const POSITIVE_VALUE_MAP = [ /* 0 to 100 */
            '00000000', '0800030f', '00000400', '04000400', '08000400', '0a000400', '0c000400', '0e000400', '00000401', '01000401', '02000401', '03000401', '04000401', '05000401', '06000401', '07000401', '08000401', '08080401', '09000401', '09080401', '0a000401', '0a080401', '0b000401', '0b080401', '0c000401', '0c080401', '0d000401', '0d080401', '0e000401', '0e080401', '0f000401', '0f080401', '00000402', '00040402', '00080402', '000c0402', '01000402', '01040402', '01080402', '010c0402', '02000402', '02040402', '02080402', '020c0402', '03000402', '03040402', '03080402', '030c0402', '04000402', '04040402', '04080402', '040c0402', '05000402', '05040402', '05080402', '050c0402', '06000402', '06040402', '06080402', '060c0402', '07000402', '07040402', '07080402', '070c0402', '08000402', '08020402', '08040402', '08060402', '08080402', '080a0402', '080c0402', '080e0402', '09000402', '09020402', '09040402', '09060402', '09080402', '090a0402', '090c0402', '090e0402', '0a000402', 'a020402', '0a040402', '0a060402', '0a080402', '0a0a0402', '0a0c0402', '0a0e0402', '0b000402', '0b020402', '0b040402', '0b060402', '0b080402', '0b0a0402', '0b0c0402', '0b0e0402', '0c000402', '0c020402', '0c040402', '0c060402', '0c080402'
        ];
        const NEGATIVE_VALUE_MAP = [ /* -50 to -1 */
            '04080C02', '04040C02', '04000C02', '030C0C02', '03080C02', '03040C02', '03000C02', '020C0C02', '02080C02', '02040C02', '02000C02', '010C0C02', '01080C02', '01040C02', '01000C02', '000C0C02', '00080C02', '00040C02', '00000C02', '0F080C01', '0F000C01', '0E080C01', '0E000C01', '0D080C01', '0D000C01', '0C080C01', '0C000C01', '0B080C01', '0B000C01', '0A080C01', '0A000C01', '09080C01', '09000C01', '08080C01', '08000C01', '07000C01', '06000C01', '05000C01', '04000C01', '03000C01', '02000C01', '01000C01', '00000C01', '0E000C00', '0C000C00', '0A000C00', '08000C00', '04000C00', '00000C00', '08000B0F'
        ];
        
        // --- REVERSE MAPPING (General) ---
        const REVERSE_VALUE_MAP = new Map();
        NEGATIVE_VALUE_MAP.forEach((val, i) => REVERSE_VALUE_MAP.set(val.toLowerCase(), i - 50));
        POSITIVE_VALUE_MAP.forEach((val, i) => REVERSE_VALUE_MAP.set(val.toLowerCase(), i));
        
        // --- DELAY-SPECIFIC MAPPING (Alg 1, Mod 7) ---
        const DELAY_HEX_TO_VALUE_MAP = new Map();
        const DELAY_VALUE_TO_HEX_MAP = new Map();
        
        // Data derived from allmssettings.txt to ensure 100% accuracy
        const delayData = { 20: "0a000401", 21: "0a080401", 22: "0b000401", 23: "0b080401", 24: "0c000401", 25: "0c080401", 26: "0d000401", 27: "0d080401", 28: "0e000401", 29: "0e080401", 30: "0f000401", 31: "0f080401", 32: "00000402", 33: "00040402", 34: "00080402", 35: "000c0402", 36: "01000402", 37: "01040402", 38: "01080402", 39: "010c0402", 40: "02000402", 41: "02040402", 42: "02080402", 43: "020c0402", 44: "03000402", 45: "03040402", 46: "03080402", 47: "030c0402", 48: "04000402", 49: "04040402", 50: "04080402", 51: "040c0402", 52: "05000402", 53: "05040402", 54: "05080402", 55: "050c0402", 56: "06000402", 57: "06040402", 58: "06080402", 59: "060c0402", 60: "07000402", 61: "07040402", 62: "07080402", 63: "070c0402", 64: "08000402", 65: "08020402", 66: "08040402", 67: "08060402", 68: "08080402", 69: "080a0402", 70: "080c0402", 71: "080e0402", 72: "09000402", 73: "09020402", 74: "09040402", 75: "09060402", 76: "09080402", 77: "090a0402", 78: "090c0402", 79: "090e0402", 80: "0a000402", 81: "0a020402", 82: "0a040402", 83: "0a060402", 84: "0a080402", 85: "0a0a0402", 86: "0a0c0402", 87: "0a0e0402", 88: "0b000402", 89: "0b020402", 90: "0b040402", 91: "0b060402", 92: "0b080402", 93: "0b0a0402", 94: "0b0c0402", 95: "0b0e0402", 96: "0c000402", 97: "0c020402", 98: "0c040402", 99: "0c060402", 100: "0c080402", 101: "0c0a0402", 102: "0c0c0402", 103: "0c0e0402", 104: "0d000402", 105: "0d020402", 106: "0d040402", 107: "0d060402", 108: "0d080402", 109: "0d0a0402", 110: "0d0c0402", 111: "0d0e0402", 112: "0e000402", 113: "0e020402", 114: "0e040402", 115: "0e060402", 116: "0e080402", 117: "0e0a0402", 118: "0e0c0402", 119: "0e0e0402", 120: "0f000402", 121: "0f020402", 122: "0f040402", 123: "0f060402", 124: "0f080402", 125: "0f0a0402", 126: "0f0c0402", 127: "0f0e0402", 128: "00000403", 129: "00010403", 130: "00020403", 131: "00030403", 132: "00040403", 133: "00050403", 134: "00060403", 135: "00070403", 136: "00080403", 137: "00090403", 138: "000a0403", 139: "000b0403", 140: "000c0403", 141: "000d0403", 142: "000e0403", 143: "000f0403", 144: "01000403", 145: "01010403", 146: "01020403", 147: "01030403", 148: "01040403", 149: "01050403", 150: "01060403", 151: "01070403", 152: "01080403", 153: "01090403", 154: "010a0403", 155: "010b0403", 156: "010c0403", 157: "010d0403", 158: "010e0403", 159: "010f0403", 160: "02000403", 161: "02010403", 162: "02020403", 163: "02030403", 164: "02040403", 165: "02050403", 166: "02060403", 167: "02070403", 168: "02080403", 169: "02090403", 170: "020a0403", 171: "020b0403", 172: "020c0403", 173: "020d0403", 174: "020e0403", 175: "020f0403", 176: "03000403", 177: "03010403", 178: "03020403", 179: "03030403", 180: "03040403", 181: "03050403", 182: "03060403", 183: "03070403", 184: "03080403", 185: "03090403", 186: "030a0403", 187: "030b0403", 188: "030c0403", 189: "030d0403", 190: "030e0403", 191: "030f0403", 192: "04000403", 193: "04010403", 194: "04020403", 195: "04030403", 196: "04040403", 197: "04050403", 198: "04060403", 199: "04070403", 200: "04080403", 201: "04090403", 202: "040a0403", 203: "040b0403", 204: "040c0403", 205: "040d0403", 206: "040e0403", 207: "040f0403", 208: "05000403", 209: "05010403", 210: "05020403", 211: "05030403", 212: "05040403", 213: "05050403", 214: "05060403", 215: "05070403", 216: "05080403", 217: "05090403", 218: "050a0403", 219: "050b0403", 220: "050c0403", 221: "050d0403", 222: "050e0403", 223: "050f0403", 224: "06000403", 225: "06010403", 226: "06020403", 227: "06030403", 228: "06040403", 229: "06050403", 230: "06060403", 231: "06070403", 232: "06080403", 233: "06090403", 234: "060a0403", 235: "060b0403", 236: "060c0403", 237: "060d0403", 238: "060e0403", 239: "060f0403", 240: "07000403", 241: "07010403", 242: "07020403", 243: "07030403", 244: "07040403", 245: "07050403", 246: "07060403", 247: "07070403", 248: "07080403", 249: "07090403", 250: "070a0403", 251: "070b0403", 252: "070c0403", 253: "070d0403", 254: "070e0403", 255: "070f0403", 256: "08000403", 257: "08000403", 258: "08010403", 259: "08010403", 260: "08020403", 261: "08020403", 262: "08030403", 263: "08030403", 264: "08040403", 265: "08040403", 266: "08050403", 267: "08050403", 268: "08060403", 269: "08060403", 270: "08070403", 271: "08070403", 272: "08080403", 273: "08080403", 274: "08090403", 275: "08090403", 276: "080a0403", 277: "080a0403", 278: "080b0403", 279: "080b0403", 280: "080c0403", 281: "080c0403", 282: "080d0403", 283: "080d0403", 284: "080e0403", 285: "080e0403", 286: "080f0403", 287: "080f0403", 288: "09000403", 289: "09000403", 290: "09010403", 291: "09010403", 292: "09020403", 293: "09020403", 294: "09030403", 295: "09030403", 296: "09040403", 297: "09040403", 298: "09050403", 299: "09050403", 300: "09060403", 301: "09060403", 302: "09070403", 303: "09070403", 304: "09080403", 305: "09080403", 306: "09090403", 307: "09090403", 308: "090a0403", 309: "090a0403", 310: "090b0403", 311: "090b0403", 312: "090c0403", 313: "090c0403", 314: "090d0403", 315: "090d0403", 316: "090e0403", 317: "090e0403", 318: "090f0403", 319: "090f0403", 320: "0a000403", 321: "0a000403", 322: "0a010403", 323: "0a010403", 324: "0a020403", 325: "0a020403", 326: "0a030403", 327: "0a030403", 328: "0a040403", 329: "0a040403", 330: "0a050403", 331: "0a050403", 332: "0a060403", 333: "0a060403", 334: "0a070403", 335: "0a070403", 336: "0a080403", 337: "0a080403", 338: "0a090403", 339: "0a090403", 340: "0a0a0403", 341: "0a0a0403", 342: "0a0b0403", 343: "0a0b0403", 344: "0a0c0403", 345: "0a0c0403", 346: "0a0d0403", 347: "0a0d0403", 348: "0a0e0403", 349: "0a0e0403", 350: "0a0f0403", 351: "0a0f0403", 352: "0b000403", 353: "0b000403", 354: "0b010403", 355: "0b010403", 356: "0b020403", 357: "0b020403", 358: "0b030403", 359: "0b030403", 360: "0b040403", 361: "0b040403", 362: "0b050403", 363: "0b050403", 364: "0b060403", 365: "0b060403", 366: "0b070403", 367: "0b070403", 368: "0b080403", 369: "0b080403", 370: "0b090403", 371: "0b090403", 372: "0b0a0403", 373: "0b0a0403", 374: "0b0b0403", 375: "0b0b0403", 376: "0b0c0403", 377: "0b0c0403", 378: "0b0d0403", 379: "0b0d0403", 380: "0b0e0403", 381: "0b0e0403", 382: "0b0f0403", 383: "0b0f0403", 384: "0c000403", 385: "0c000403", 386: "0c010403", 387: "0c010403", 388: "0c020403", 389: "0c020403", 390: "0c030403", 391: "0c030403", 392: "0c040403", 393: "0c040403", 394: "0c050403", 395: "0c050403", 396: "0c060403", 397: "0c060403", 398: "0c070403", 399: "0c070403", 400: "0c080403", 401: "0c080403", 402: "0c090403", 403: "0c090403", 404: "0c0a0403", 405: "0c0a0403", 406: "0c0b0403", 407: "0c0b0403", 408: "0c0c0403", 409: "0c0c0403", 410: "0c0d0403", 411: "0c0d0403", 412: "0c0e0403", 413: "0c0e0403", 414: "0c0f0403", 415: "0c0f0403", 416: "0d000403", 417: "0d000403", 418: "0d010403", 419: "0d010403", 420: "0d020403", 421: "0d020403", 422: "0d030403", 423: "0d030403", 424: "0d040403", 425: "0d040403", 426: "0d050403", 427: "0d050403", 428: "0d060403", 429: "0d060403", 430: "0d070403", 431: "0d070403", 432: "0d080403", 433: "0d080403", 434: "0d090403", 435: "0d090403", 436: "0d0a0403", 437: "0d0a0403", 438: "0d0b0403", 439: "0d0b0403", 440: "0d0c0403", 441: "0d0c0403", 442: "0d0d0403", 443: "0d0d0403", 444: "0d0e0403", 445: "0d0e0403", 446: "0d0f0403", 447: "0d0f0403", 448: "0e000403", 449: "0e000403", 450: "0e010403", 451: "0e010403", 452: "0e020403", 453: "0e020403", 454: "0e030403", 455: "0e030403", 456: "0e040403", 457: "0e040403", 458: "0e050403", 459: "0e050403", 460: "0e060403", 461: "0e060403", 462: "0e070403", 463: "0e070403", 464: "0e080403", 465: "0e080403", 466: "0e090403", 467: "0e090403", 468: "0e0a0403", 469: "0e0a0403", 470: "0e0b0403", 471: "0e0b0403", 472: "0e0c0403", 473: "0e0c0403", 474: "0e0d0403", 475: "0e0d0403", 476: "0e0e0403", 477: "0e0e0403", 478: "0e0f0403", 479: "0e0f0403", 480: "0f000403", 481: "0f000403", 482: "0f010403", 483: "0f010403", 484: "0f020403", 485: "0f020403", 486: "0f030403", 487: "0f030403", 488: "0f040403", 489: "0f040403", 490: "0f050403", 491: "0f050403", 492: "0f060403", 493: "0f060403", 494: "0f070403", 495: "0f070403", 496: "0f080403", 497: "0f080403", 498: "0f090403", 499: "0f090403", 500: "0f0a0403", 501: "0f0a0403", 502: "0f0b0403", 503: "0f0b0403", 504: "0f0c0403", 505: "0f0c0403", 506: "0f0d0403", 507: "0f0d0403", 508: "0f0e0403", 509: "0f0e0403", 510: "0f0f0403", 511: "0f0f0403", 512: "00000404", 513: "00000404", 514: "00000404", 515: "00000404", 516: "00010404", 517: "00010404", 518: "00010404", 519: "00010404", 520: "00020404", 521: "00020404", 522: "00020404", 523: "00020404", 524: "00030404", 525: "00030404", 526: "00030404", 527: "00030404", 528: "00040404", 529: "00040404", 530: "00040404", 531: "00040404", 532: "00050404", 533: "00050404", 534: "00050404", 535: "00050404", 536: "00060404", 537: "00060404", 538: "00060404", 539: "00060404", 540: "00070404", 541: "00070404", 542: "00070404", 543: "00070404", 544: "00080404", 545: "00080404", 546: "00080404", 547: "00080404", 548: "00090404", 549: "00090404", 550: "00090404", 551: "00090404", 552: "000a0404", 553: "000a0404", 554: "000a0404", 555: "000a0404", 556: "000b0404", 557: "000b0404", 558: "000b0404", 559: "000b0404", 560: "000c0404", 561: "000c0404", 562: "000c0404", 563: "000c0404", 564: "000d0404", 565: "000d0404", 566: "000d0404", 567: "000d0404", 568: "000e0404", 569: "000e0404", 570: "000e0404", 571: "000e0404", 572: "000f0404", 573: "000f0404", 574: "000f0404", 575: "000f0404", 576: "01000404", 577: "01000404", 578: "01000404", 579: "01000404", 580: "01010404", 581: "01010404", 582: "01010404", 583: "01010404", 584: "01020404", 585: "01020404", 586: "01020404", 587: "01020404", 588: "01030404", 589: "01030404", 590: "01030404", 591: "01030404", 592: "01040404", 593: "01040404", 594: "01040404", 595: "01040404", 596: "01050404", 597: "01050404", 598: "01050404", 599: "01050404", 600: "01060404", 601: "01060404", 602: "01060404", 603: "01060404", 604: "01070404", 605: "01070404", 606: "01070404", 607: "01070404", 608: "01080404", 609: "01080404", 610: "01080404", 611: "01080404", 612: "01090404", 613: "01090404", 614: "01090404", 615: "01090404", 616: "010a0404", 617: "010a0404", 618: "010a0404", 619: "010a0404", 620: "010b0404", 621: "010b0404", 622: "010b0404", 623: "010b0404", 624: "010c0404", 625: "010c0404", 626: "010c0404", 627: "010c0404", 628: "010d0404", 629: "010d0404", 630: "010d0404", 631: "010d0404", 632: "010e0404", 633: "010e0404", 634: "010e0404", 635: "010e0404", 636: "010f0404", 637: "010f0404", 638: "010f0404", 639: "010f0404", 640: "02000404", 641: "02000404", 642: "02000404", 643: "02000404", 644: "02010404", 645: "02010404", 646: "02010404", 647: "02010404", 648: "02020404", 649: "02020404", 650: "02020404", 651: "02020404", 652: "02030404", 653: "02030404", 654: "02030404", 655: "02030404", 656: "02040404", 657: "02040404", 658: "02040404", 659: "02040404", 660: "02050404", 661: "02050404", 662: "02050404", 663: "02050404", 664: "02060404", 665: "02060404", 666: "02060404", 667: "02060404", 668: "02070404", 669: "02070404", 670: "02070404", 671: "02070404", 672: "02080404", 673: "02080404", 674: "02080404", 675: "02080404", 676: "02090404", 677: "02090404", 678: "02090404", 679: "02090404", 680: "020a0404", 681: "020a0404", 682: "020a0404", 683: "020a0404", 684: "020b0404", 685: "020b0404", 686: "020b0404", 687: "020b0404", 688: "020c0404", 689: "020c0404", 690: "020c0404", 691: "020c0404", 692: "020d0404", 693: "020d0404", 694: "020d0404", 695: "020d0404", 696: "020e0404", 697: "020e0404", 698: "020e0404", 699: "020e0404", 700: "020f0404", 701: "020f0404", 702: "020f0404", 703: "020f0404", 704: "03000404", 705: "03000404", 706: "03000404", 707: "03000404", 708: "03010404", 709: "03010404", 710: "03010404", 711: "03010404", 712: "03020404", 713: "03020404", 714: "03020404", 715: "03020404", 716: "03030404", 717: "03030404", 718: "03030404", 719: "03030404", 720: "03040404", 721: "03040404", 722: "03040404", 723: "03040404", 724: "03050404", 725: "03050404", 726: "03050404", 727: "03050404", 728: "03060404", 729: "03060404", 730: "03060404", 731: "03060404", 732: "03070404", 733: "03070404", 734: "03070404", 735: "03070404", 736: "03080404", 737: "03080404", 738: "03080404", 739: "03080404", 740: "03090404", 741: "03090404", 742: "03090404", 743: "03090404", 744: "030a0404", 745: "030a0404", 746: "030a0404", 747: "030a0404", 748: "030b0404", 749: "030b0404", 750: "030b0404", 751: "030b0404", 752: "030c0404", 753: "030c0404", 754: "030c0404", 755: "030c0404", 756: "030d0404", 757: "030d0404", 758: "030d0404", 759: "030d0404", 760: "030e0404", 761: "030e0404", 762: "030e0404", 763: "030e0404", 764: "030f0404", 765: "030f0404", 766: "030f0404", 767: "030f0404", 768: "04000404", 769: "04000404", 770: "04000404", 771: "04000404", 772: "04010404", 773: "04010404", 774: "04010404", 775: "04010404", 776: "04020404", 777: "04020404", 778: "04020404", 779: "04020404", 780: "04030404", 781: "04030404", 782: "04030404", 783: "04030404", 784: "04040404", 785: "04040404", 786: "04040404", 787: "04040404", 788: "04050404", 789: "04050404", 790: "04050404", 791: "04050404", 792: "04060404", 793: "04060404", 794: "04060404", 795: "04060404", 796: "04070404", 797: "04070404", 798: "04070404", 799: "04070404", 800: "04080404", 801: "04080404", 802: "04080404", 803: "04080404", 804: "04090404", 805: "04090404", 806: "04090404", 807: "04090404", 808: "040a0404", 809: "040a0404", 810: "040a0404", 811: "040a0404", 812: "040b0404", 813: "040b0404", 814: "040b0404", 815: "040b0404", 816: "040c0404", 817: "040c0404", 818: "040c0404", 819: "040c0404", 820: "040d0404", 821: "040d0404", 822: "040d0404", 823: "040d0404", 824: "040e0404", 825: "040e0404", 826: "040e0404", 827: "040e0404", 828: "040f0404", 829: "040f0404", 830: "040f0404", 831: "040f0404", 832: "05000404", 833: "05000404", 834: "05000404", 835: "05000404", 836: "05010404", 837: "05010404", 838: "05010404", 839: "05010404", 840: "05020404", 841: "05020404", 842: "05020404", 843: "05020404", 844: "05030404", 845: "05030404", 846: "05030404", 847: "05030404", 848: "05040404", 849: "05040404", 850: "05040404", 851: "05040404", 852: "05050404", 853: "05050404", 854: "05050404", 855: "05050404", 856: "05060404", 857: "05060404", 858: "05060404", 859: "05060404", 860: "05070404", 861: "05070404", 862: "05070404", 863: "05070404", 864: "05080404", 865: "05080404", 866: "05080404", 867: "05080404", 868: "05090404", 869: "05090404", 870: "05090404", 871: "05090404", 872: "050a0404", 873: "050a0404", 874: "050a0404", 875: "050a0404", 876: "050b0404", 877: "050b0404", 878: "050b0404", 879: "050b0404", 880: "050c0404", 881: "050c0404", 882: "050c0404", 883: "050c0404", 884: "050d0404", 885: "050d0404", 886: "050d0404", 887: "050d0404", 888: "050e0404", 889: "050e0404", 890: "050e0404", 891: "050e0404", 892: "050f0404", 893: "050f0404", 894: "050f0404", 895: "050f0404", 896: "06000404", 897: "06000404", 898: "06000404", 899: "06000404", 900: "06010404", 901: "06010404", 902: "06010404", 903: "06010404", 904: "06020404", 905: "06020404", 906: "06020404", 907: "06020404", 908: "06030404", 909: "06030404", 910: "06030404", 911: "06030404", 912: "06040404", 913: "06040404", 914: "06040404", 915: "06040404", 916: "06050404", 917: "06050404", 918: "06050404", 919: "06050404", 920: "06060404", 921: "06060404", 922: "06060404", 923: "06060404", 924: "06070404", 925: "06070404", 926: "06070404", 927: "06070404", 928: "06080404", 929: "06080404", 930: "06080404", 931: "06080404", 932: "06090404", 933: "06090404", 934: "06090404", 935: "06090404", 936: "060a0404", 937: "060a0404", 938: "060a0404", 939: "060a0404", 940: "060b0404", 941: "060b0404", 942: "060b0404", 943: "060b0404", 944: "060c0404", 945: "060c0404", 946: "060c0404", 947: "060c0404", 948: "060d0404", 949: "060d0404", 950: "060d0404", 951: "060d0404", 952: "060e0404", 953: "060e0404", 954: "060e0404", 955: "060e0404", 956: "060f0404", 957: "060f0404", 958: "060f0404", 959: "060f0404", 960: "07000404", 961: "07000404", 962: "07000404", 963: "07000404", 964: "07010404", 965: "07010404", 966: "07010404", 967: "07010404", 968: "07020404", 969: "07020404", 970: "07020404", 971: "07020404", 972: "07030404", 973: "07030404", 974: "07030404", 975: "07030404", 976: "07040404", 977: "07040404", 978: "07040404", 979: "07040404", 980: "07050404", 981: "07050404", 982: "07050404", 983: "07050404", 984: "07060404", 985: "07060404", 986: "07060404", 987: "07060404", 988: "07070404", 989: "07070404", 990: "07070404", 991: "07070404", 992: "07080404", 993: "07080404", 994: "07080404", 995: "07080404", 996: "07090404", 997: "07090404", 998: "07090404", 999: "07090404", 1000: "070a0404" };
        for (const [value, hex] of Object.entries(delayData)) {
            DELAY_HEX_TO_VALUE_MAP.set(hex, parseInt(value));
            DELAY_VALUE_TO_HEX_MAP.set(parseInt(value), hex);
        }

        // --- ANALYSIS LOGIC ---
        analyzeBtn.addEventListener('click', () => {
            const text = snoopedDataInput.value;
            const regex = /8080f0[a-fA-F0-9]{10,}f7/gi;
            const foundCommands = text.match(regex) || [];
            
            if (foundCommands.length === 0) {
                resultsOutput.value = "No valid commands found in the input data.";
                return;
            }

            const uniqueCommands = [...new Set(foundCommands.map(cmd => cmd.toLowerCase()))];
            let identified = [];
            let unidentified = [];
            const ID_MARKER = '0e0101040800';

            for (const cmd of uniqueCommands) {
                const markerIndex = cmd.indexOf(ID_MARKER);

                if (markerIndex === -1) {
                    unidentified.push(cmd);
                    continue;
                }

                const moduleIdIndex = markerIndex + ID_MARKER.length;
                const algIdIndex = moduleIdIndex + 16;
                const moduleId = parseInt(cmd.substring(moduleIdIndex, moduleIdIndex + 2), 16);
                const algId = parseInt(cmd.substring(algIdIndex, algIdIndex + 2), 16);
                const valueBlock = cmd.substring(cmd.length - 10, cmd.length - 2);

                let foundValue = null;
                let valueUnit = '';
                
                if (algId === 1 && moduleId === 7) {
                    foundValue = DELAY_HEX_TO_VALUE_MAP.get(valueBlock) ?? null;
                    valueUnit = 'ms';
                } else {
                    foundValue = REVERSE_VALUE_MAP.get(valueBlock) ?? null;
                }
                
                identified.push({
                    name: `Alg ${algId}, Mod ${moduleId}, Value: ${foundValue !== null ? foundValue + valueUnit : 'N/A'}`,
                    command: cmd,
                    algId: algId,
                    moduleId: moduleId,
                    value: foundValue,
                    unit: valueUnit
                });
            }

            identified.sort((a, b) => {
                if (a.algId !== b.algId) return a.algId - b.algId;
                if (a.moduleId !== b.moduleId) return a.moduleId - b.moduleId;
                if (a.value === null) return -1;
                if (b.value === null) return 1;
                return a.value - b.value;
            });

            const missingCommands = findMissing(identified.filter(c => c.value !== null));
            lastMissingCommands = { missing: missingCommands, identified: identified }; // Store results
            const generatePayloadBtn = document.getElementById('generatePayloadBtn');

            if (Object.keys(missingCommands).length > 0) {
                generatePayloadBtn.disabled = false;
            } else {
                generatePayloadBtn.disabled = true;
            }

            let output = `--- ANALYSIS COMPLETE ---\n`;
            output += `Found ${foundCommands.length} commands, with ${uniqueCommands.length} unique.\n\n`;

            if(unidentified.length > 0) {
                output += `--- UNIDENTIFIED COMMANDS (${unidentified.length}) ---\n`;
                output += "(These did not contain the ID marker '0e0101040800'.)\n";
                output += unidentified.join('\n') + '\n\n';
            }

            output += `--- IDENTIFIED & SORTED COMMANDS (${identified.length}) ---\n`;
            let currentAlgId = null;
            let currentModuleId = null;
            identified.forEach(item => {
                if (item.algId !== currentAlgId) {
                    currentAlgId = item.algId;
                    currentModuleId = null; 
                    output += `\n// --- Algorithm ID: ${currentAlgId} ---\n`;
                }
                if (item.moduleId !== currentModuleId) {
                    currentModuleId = item.moduleId;
                    output += `  // --- Module ID: ${currentModuleId} ---\n`;
                }
                output += `  '${item.name}': '${item.command}',\n`;
            });
            output += `\n`;
            
            output += `--- MISSING VALUES REPORT ---\n`;
            if (Object.keys(missingCommands).length === 0) {
                output += "No values appear to be missing from the identified parameter groups.\n";
            } else {
                 for(const paramName in missingCommands) {
                     output += `${paramName}: MISSING GAPS\n`;
                     output += `  [${missingCommands[paramName].join(', ')}]\n`;
                 }
            }

            resultsOutput.value = output;
        });

        function findMissing(found) {
            const missing = {};
            const paramGroups = new Map();
            found.forEach(c => {
                const key = `Algorithm ${c.algId}, Module ${c.moduleId}`;
                if (!paramGroups.has(key)) {
                    paramGroups.set(key, []);
                }
                paramGroups.get(key).push(c.value);
            });

            for (const [paramName, values] of paramGroups.entries()) {
                const valueSet = new Set(values);
                let min, max;
                
                if (paramName === 'Algorithm 1, Module 7') {
                    min = 20;
                    max = 1000;
                } else {
                    if (values.length < 2) continue;
                    const sortedValues = [...values].sort((a, b) => a - b);
                    min = sortedValues[0];
                    max = sortedValues[sortedValues.length - 1];
                }

                const missingValues = [];
                for (let i = min; i <= max; i++) {
                    // For the special case, we need to check if a value is defined in our map,
                    // as not every integer value has a corresponding command.
                    if (paramName === 'Algorithm 1, Module 7') {
                        if (DELAY_VALUE_TO_HEX_MAP.has(i) && !valueSet.has(i)) {
                            missingValues.push(i);
                        }
                    } else { // Generic case
                        if (!valueSet.has(i)) {
                            missingValues.push(i);
                        }
                    }
                }

                if (missingValues.length > 0) {
                    missing[paramName] = missingValues;
                }
            }
            return missing;
        }

    // Add this entire block to the end of your <script> tag

// FORWARD MAP for generic values (-50 to 100)
const FORWARD_VALUE_MAP = new Map();
NEGATIVE_VALUE_MAP.forEach((val, i) => FORWARD_VALUE_MAP.set(i - 50, val.toLowerCase()));
POSITIVE_VALUE_MAP.forEach((val, i) => FORWARD_VALUE_MAP.set(i, val.toLowerCase()));


document.getElementById('generatePayloadBtn').addEventListener('click', () => {
    if (!lastMissingCommands.missing || Object.keys(lastMissingCommands.missing).length === 0) {
        alert("No missing commands were found in the last analysis.");
        return;
    }

    let allGeneratedPayloads = [];
    let report = `// --- Generated Payloads for Missing Commands ---\n\n`;

    // Process each parameter group that has missing values
    for (const paramName in lastMissingCommands.missing) {
        report += `// ${paramName}\n`;
        const missingValues = lastMissingCommands.missing[paramName];
        
        // Find a template command from the original snooped data for this group
        const template = lastMissingCommands.identified.find(cmd => `Algorithm ${cmd.algId}, Module ${cmd.moduleId}` === paramName);

        if (!template) {
            report += `// Could not find a template command to generate payloads for this group.\n\n`;
            continue;
        }

        for (const value of missingValues) {
            let newValuePart = null;
            
            // Get the hex value part for the missing integer
            if (template.algId === 1 && template.moduleId === 7) {
                // Special case for Delay Time
                newValuePart = DELAY_VALUE_TO_HEX_MAP.get(value);
            } else {
                // Generic case
                newValuePart = FORWARD_VALUE_MAP.get(value);
            }

            if (newValuePart) {
                // Generate the full command by replacing the value part in the template
                const newCommand = template.command.slice(0, -10) + newValuePart + template.command.slice(-2);
                report += `'${paramName}, Missing Value: ${value}': '${newCommand}',\n`;
                allGeneratedPayloads.push(newCommand);
            }
        }
        report += '\n';
    }

    // --- Create and trigger the download ---
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'missing_command_payloads.txt';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
});

    </script>
</body>
</html>

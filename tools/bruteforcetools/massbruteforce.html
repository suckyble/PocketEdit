<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pedal Batch Cracker v20</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a1a; color: #e0e0e0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .progress-section { margin: 20px 0; display: none; background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        #statusHeader { font-size: 14px; color: #87cefa; margin-bottom: 5px; font-weight: bold; display: block; }
        .progress-container { width: 100%; background-color: #111; border-radius: 10px; height: 10px; overflow: hidden; }
        #progressBar { width: 0%; height: 100%; background-color: #00a300; transition: width 0.1s; }
        #subStatus { font-size: 11px; color: #888; margin-top: 5px; font-family: monospace; text-align: right; display: block; }
        textarea { width: 100%; height: 100px; background: #252525; color: #00ff00; border: 1px solid #444; padding: 10px; font-family: monospace; border-radius: 5px; width: -webkit-fill-available; }
        #log { height: 160px; background: #000; border: 1px solid #333; overflow-y: scroll; padding: 10px; font-family: monospace; font-size: 11px; border-radius: 5px; margin-bottom: 10px; white-space: pre-wrap; }
        .controls { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 15px 0; }
        button { padding: 12px; font-weight: bold; cursor: pointer; border-radius: 5px; border: none; background: #333; color: white; transition: 0.2s; font-size: 12px; }
        #connectBtn { background: #2b5797; }
        #connectBtn:disabled { background: #2d3e50; color: #666; cursor: default; opacity: 0.6; }
        #startBtn { background: #00a300; }
        #abortBtn { background: #c0392b; display: none; }
        #clearBtn { background: #555; }
        .manual-section { background: #252525; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #444; }
        .manual-input-row { display: flex; gap: 10px; margin-top: 10px; }
        .manual-input-row input { flex-grow: 1; background: #000; border: 1px solid #555; color: #00ff00; padding: 10px; font-family: monospace; border-radius: 4px; }
        #manualTestBtn { background: #8e44ad; min-width: 140px; }
        .results-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .box { padding: 15px; border-radius: 5px; border: 1px solid #444; min-height: 250px; }
        .success-box { background: #1e3a1e; border-color: #2d5a2d; }
        .candidate-box { background: #2a2a2d; border-color: #444; }
        .item { border-bottom: 1px solid #333; padding: 10px 0; font-family: monospace; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .valid { color: #00ff00; font-weight: bold; }
        .verify-btn { background: #8e44ad; padding: 5px 10px; font-size: 10px; border-radius: 3px; border: none; color: white; cursor: pointer; }
        .tag-ok { background: #00a300; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pedal Cracker v20</h1>
        <textarea id="payloadInput" placeholder="Paste logs here (Batch Mode)..."></textarea>
        <div class="controls">
            <button id="connectBtn">1. Connect</button>
            <button id="startBtn" disabled>2. Start Batch</button>
            <button id="abortBtn">Abort</button>
            <button id="downloadBtn">3. Download</button>
            <button id="clearBtn">Clear All</button>
        </div>
        <div class="progress-section" id="pSection">
            <span id="statusHeader">Ready...</span>
            <div class="progress-container"><div id="progressBar"></div></div>
            <span id="subStatus">Idle</span>
        </div>
        <div id="log"></div>
        <div class="manual-section">
            <h3 style="margin:0">Manual Single-Command Test</h3>
            <div class="manual-input-row">
                <input type="text" id="manualInput" placeholder="Enter full hex command...">
                <button id="manualTestBtn" disabled>Test Code</button>
            </div>
        </div>
        <div class="results-container">
            <div class="box success-box">
                <h3 style="margin:0">Verified Results (<span id="successCount">0</span>)</h3>
                <div id="successList"></div>
            </div>
            <div class="box candidate-box">
                <h3 style="margin:0">Pending Verification (<span id="candidateCount">0</span>)</h3>
                <div id="candidateList"></div>
            </div>
        </div>
    </div>

    <script>
        const SERVICE_UUID = '03b80e5a-ede8-4b33-a751-6ce34ec4c700';
        const CHARACTERISTIC_UUID = '7772e5db-3868-4112-a1a9-f2669d106bf3';
        const SUCCESS_ACK_CODE = "8080f00b02000100000003010400080000f7";

        let device, characteristic, ackResolver;
        let lastCommand = "NONE", secondLastCommand = "NONE";
        let sessionResults = [], isAborting = false;

        const yieldToMain = () => new Promise(resolve => setTimeout(resolve, 0));

        function log(msg, color = "#e0e0e0") {
            const span = document.createElement('div');
            span.style.color = color;
            span.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('log').appendChild(span);
            document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
        }

        document.getElementById('connectBtn').onclick = async () => {
            try {
                device = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', (e) => {
                    const hex = Array.from(new Uint8Array(e.target.value.buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
                    if (hex.toLowerCase() === SUCCESS_ACK_CODE.toLowerCase() && ackResolver) ackResolver(true);
                });
                const btn = document.getElementById('connectBtn');
                btn.disabled = true;
                btn.textContent = "Connected";
                document.getElementById('startBtn').disabled = false;
                document.getElementById('manualTestBtn').disabled = false;
                log("Connected.", "#00ff00");
            } catch (err) { log("Error: " + err.message, "#ff4444"); }
        };

        // ABORT BUTTON FIX
        document.getElementById('abortBtn').onclick = () => {
            isAborting = true;
            log("ðŸ›‘ Abort clicked: Finishing and moving to verification pass.", "#ff9900");
        };

        // CLEAR ALL FIX: Clears log, memory, and UI
        document.getElementById('clearBtn').onclick = () => {
            if(confirm("Clear log and all session results?")) { 
                sessionResults = []; 
                document.getElementById('log').innerHTML = "";
                document.getElementById('successCount').textContent = "0";
                document.getElementById('candidateCount').textContent = "0";
                updateUI(); 
                log("Session and log cleared.", "#87cefa");
            }
        };

        async function writeCommand(cmd) {
            secondLastCommand = lastCommand; lastCommand = cmd;
            const bytes = new Uint8Array(cmd.replace(/\s/g, '').match(/.{1,2}/g).map(b => parseInt(b, 16)));
            await characteristic.writeValueWithoutResponse(bytes);
        }

        function waitForAck(timeout = 250) {
            return new Promise(res => {
                ackResolver = res;
                setTimeout(() => { ackResolver = null; res(false); }, timeout);
            });
        }

        window.manualVerify = async (id) => {
            const item = sessionResults.find(r => r.id === id);
            log(`Manual Check: ${item.cmd}`, "#8e44ad");
            await writeCommand(item.cmd);
            if (await waitForAck(500)) {
                item.verified = true;
                log("ACK Received! Verified.", "#00ff00");
            } else {
                log("Fail. Trying Backup...", "#ff9900");
                await writeCommand(item.backup);
                if (await waitForAck(500)) {
                    item.cmd = item.backup; item.verified = true;
                    log("Backup ACK Received! Verified.", "#00ff00");
                } else { log("Fail.", "#ff4444"); }
            }
            updateUI();
        };

        function updateUI() {
            const successList = document.getElementById('successList');
            const candidateList = document.getElementById('candidateList');
            successList.innerHTML = ""; candidateList.innerHTML = "";
            sessionResults.forEach(r => {
                const div = document.createElement('div'); div.className = 'item';
                if (r.verified) {
                    div.innerHTML = `<span class="valid">${r.cmd} <span class="tag-ok">[OK]</span></span>`;
                    successList.appendChild(div);
                } else {
                    div.innerHTML = `<span>${r.cmd.substring(6,10)}...</span><button class="verify-btn" onclick="manualVerify(${r.id})">Verify</button>`;
                    candidateList.appendChild(div);
                }
            });
            document.getElementById('successCount').textContent = sessionResults.filter(r => r.verified).length;
            document.getElementById('candidateCount').textContent = sessionResults.filter(r => !r.verified).length;
        }

        document.getElementById('manualTestBtn').onclick = async () => {
            const cmd = document.getElementById('manualInput').value.trim().replace(/\s/g, '');
            if (!cmd) return;
            log(`Manual Test: ${cmd}`, "#8e44ad");
            await writeCommand(cmd);
            if (await waitForAck(500)) log("MANUAL SUCCESS: ACK received.", "#00ff00");
            else log("MANUAL FAILED: No response.", "#ff4444");
        };

        document.getElementById('startBtn').onclick = async () => {
            const rawLines = document.getElementById('payloadInput').value.trim().split(/\n/);
            const payloads = rawLines.map(line => {
                let clean = line.replace(/\s/g, '');
                if (clean.includes('010204')) clean = clean.replace('010204', '010104');
                let final = clean;
                if (clean.toLowerCase().startsWith('8080f0') && clean.toLowerCase().endsWith('f7')) final = clean.slice(10, -2);
                return final;
            }).filter(p => p.length > 0);

            isAborting = false;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('abortBtn').style.display = "block";
            document.getElementById('pSection').style.display = "block";

            // PHASE 1: SEARCH
            for (let i = 0; i < payloads.length; i++) {
                if (isAborting) break;
                const p = payloads[i];
                if (sessionResults.some(r => r.payload === p && r.verified)) continue;

                document.getElementById('statusHeader').textContent = `Task: Finding Candidate ${i+1}/${payloads.length}`;
                log(`Payload ${i+1}/${payloads.length}`, "#87cefa");

                for (let x = 0; x < 256; x++) {
                    if (isAborting) break; // Check for abort inside trial loop
                    await yieldToMain();
                    document.getElementById('progressBar').style.width = ((x+1)/256)*100 + "%";
                    document.getElementById('subStatus').textContent = `CRC Trial: ${x}/256`;
                    
                    const ck = `0${Math.floor(x/16).toString(16)}0${(x%16).toString(16)}`;
                    const cmd = `8080f0${ck}${p}f7`;
                    await writeCommand(cmd);
                    
                    if (await waitForAck(200)) {
                        log(`Found Candidate CRC: ${ck}`, "#00ff00");
                        sessionResults.push({ id: Date.now() + x, payload: p, cmd, backup: secondLastCommand, verified: false });
                        break;
                    }
                    await new Promise(r => setTimeout(r, 45));
                }
            }

            // PHASE 2: VERIFICATION (Runs even after abort for candidates found)
            const candidates = sessionResults.filter(r => !r.verified);
            if (candidates.length > 0) {
                document.getElementById('statusHeader').textContent = "Task: Verification Pass...";
                await new Promise(r => setTimeout(r, 500));
                document.getElementById('progressBar').style.backgroundColor = "#ffff00";

                for (let i = 0; i < sessionResults.length; i++) {
                    if (sessionResults[i].verified) continue;
                    await yieldToMain(); // Yield here too
                    document.getElementById('subStatus').textContent = `Verifying: ${i+1}/${sessionResults.length}`;
                    await writeCommand(sessionResults[i].cmd);
                    if (await waitForAck(400)) sessionResults[i].verified = true;
                    await new Promise(r => setTimeout(r, 100));
                }
            }

            updateUI();
            document.getElementById('statusHeader').textContent = isAborting ? "Task: Aborted (Verify Complete)" : "Task: Batch Ready.";
            document.getElementById('startBtn').disabled = false;
            document.getElementById('abortBtn').style.display = "none";
            document.getElementById('progressBar').style.backgroundColor = "#00a300";
        };

        document.getElementById('downloadBtn').onclick = () => {
            const list = sessionResults.filter(r => r.verified).map(r => r.cmd).join('\n');
            const blob = new Blob([list], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `verified_commands.txt`;
            a.click();
        };
    </script>
</body>
</html>